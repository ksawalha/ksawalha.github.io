<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>eWAY Payment Tokenization</title>
  <script>
    // Dynamically Load the eWAY Secure Fields Script
    function loadEwayScript(callback) {
      if (document.getElementById("ewayScript")) {
        return callback(); // Script already loaded, initialize immediately
      }

      let script = document.createElement("script");
      script.id = "ewayScript";
      script.src = "https://secure.ewaypayments.com/scripts/eCrypt.min.js";
      script.onload = callback;
      document.head.appendChild(script);
    }

    // Initialize Secure Fields
    function initEwaySecureFields() {
      if (!window.eWAY) {
        console.error("eWAY Secure Fields not loaded.");
        return;
      }

      eWAY.setupSecureFields({
        key: "A1001CDqLvmy0O2TmuLvFAiqWS1WlBd670FvwcDUHBmm9oeTQSpDXcWOjJg+muBPJZWSQ0",  // Your live API key
        fields: {
          cardNumber: { selector: "#secureCardNumber", placeholder: "Card Number" },
          expiry: { selector: "#secureExpiry", placeholder: "MM/YY" },
          cvv: { selector: "#secureCVV", placeholder: "CVV" },
        },
      });

      console.log("eWAY Secure Fields Initialized.");
    }

    // Get Token when "Pay Now" is clicked
    function getEwayPaymentToken() {
      return new Promise((resolve, reject) => {
        if (!window.eWAY) {
          reject("eWAY Secure Fields not loaded.");
          return;
        }

        // Request a token from eWAY
        eWAY.createToken()
          .then((response) => {
            if (response.token) {
              console.log("eWAY Token:", response.token);  // Log the token
              resolve(response.token); // Return the token
            } else {
              console.error("eWAY Tokenization Error:", response.error);
              reject(response.error);
            }
          })
          .catch((error) => {
            console.error("eWAY API Error:", error);
            reject(error);
          });
      });
    }

    // Handle the payment form submission
    function handlePaymentFormSubmit(event) {
      event.preventDefault();  // Prevent the default form submission

      getEwayPaymentToken()
        .then((token) => {
          console.log("Payment token received:", token);
          // You can now send the token to your server for payment processing
        })
        .catch((error) => {
          console.error("Tokenization failed:", error);
        });
    }

    // Initialize everything
    loadEwayScript(() => {
      initEwaySecureFields();

      // Attach the form submission event
      document.getElementById("paymentForm").addEventListener("submit", handlePaymentFormSubmit);
    });
  </script>
</head>
<body>

  <h2>eWAY Payment Tokenization Example</h2>

  <!-- Payment Form -->
  <form id="paymentForm">
    <div>
      <label for="secureCardNumber">Card Number:</label>
      <div id="secureCardNumber"></div>  <!-- eWAY iframe will be injected here -->
    </div>
    
    <div>
      <label for="secureExpiry">Expiry (MM/YY):</label>
      <div id="secureExpiry"></div>  <!-- eWAY iframe will be injected here -->
    </div>

    <div>
      <label for="secureCVV">CVV:</label>
      <div id="secureCVV"></div>  <!-- eWAY iframe will be injected here -->
    </div>

    <button type="submit">Pay Now</button>
  </form>

</body>
</html>
